# 要件定義書

## 1. 概要
Illustrator から出力された SVG 地図を読み込み、国境界レイヤーを元に国の領域ポリゴンを抽出・保存するオフライン動作の HTML + JS アプリを作成する。

## 2. 目的
- 国境線の線群から国の領域ポリゴンを生成する。
- 海岸線や島嶼の扱いを含め、国の領域の違いを分類・再構成する。
- 生成したポリゴンを一定形式で保存する。

## 3. 入力
- SVG 地図ファイル
  - サイズ: 約 2.7MB
  - 幅: 約 20,000px
  - Illustrator 出力のためパスデータや数値表記に癖がある

## 4. 出力
- HTML + JS の複数ファイル（オフライン動作）
- 国の領域ポリゴンを保存できる形式（例: JSON）
- ロジック検証用の HTML（logic_test.html）

## 5. 対象レイヤー
以下のレイヤーのみ扱い、国名などの他レイヤーは処理対象外とする。
- `_第一分高面`〜`_第五分高面`（陸地）
- `_国境界`（国境線）

## 6. 機能要件
### 6.1 国境線の取得と統合
- `_国境界` レイヤーの線群を取得し、ポリゴン化できるよう統合する。
- 既にポリゴンになっている線が混在する可能性を考慮する。
- 1 本の線が 2 国間の国境線とは限らない。
- 線と線、線と点の接続・交差を扱う。
- 交差が検出されない微小なズレでも、端点が他線分に吸着許容値以内で近接する場合は線分側に分割点を追加して接続を成立させる。
- 点線（`stroke-dasharray`）で描かれた国境線は、吸着許容値を倍率で拡大して接続できるようにする。倍率はUIで設定でき、既定値は3倍とする。

### 6.2 海岸線の取り込み
- 必要に応じて`第一分高面`の輪郭（海岸線）を国境の一部として取り込む。
- SVG を新たにパースする必要は必ずしもなく、通常の表示を活用する。
- 国境線のみで閉じる領域の内側にある海岸線は境界として扱わず統合する。
- 共有海の判定条件を満たす領域では海岸線を境界として保持し、共有海の分割は行わない。

### 6.3 国の種類と領域ルール
国の領域は以下の種類を想定する。
- 海まで国境線を引く国
  - 海まで国境線を引き、完全に閉じた国境界を持つ。
  - 国境線が海岸線と交差する。
  - 国境線の内側にある島々も同時に領有する。
  - 国の中に国境線はない。
- 内陸国
  - 国境線のみで閉じているが、外周（海）には接していない。
  - 海岸線とは接しない。
- 完全島国
  - 国境線のみで閉じており、国境線が海岸線と交差しない。
  - 領内に第一分高面の海岸線が存在する。
- 海岸線まで国境界を引く国
  - 国境線が海岸線で終了し、領海を主張しない。
  - 島々は領有しない。
  - 海岸線をトレースし、領域境界としてポリゴン化する。
- 共有する海を持つ国々
  - 陸上に国境を持ち、海の国境線もあるが互いの海境は引かれていない。
  - 見た目は海まで国境線を引く国に見えるが、領域内に海岸線までしか引かれていない国境線がある。
  - 判定条件:
    - 「国境線の片方の端が次数 2 かつもう片方が次数 1」
    - または「両端の次数が 1 で全体が他のポリゴンに内包されている」
  - 海を 1 領域として扱い、海岸線までの領域も別々の国として分ける。
  - 島々は海領域に領有される。
- 島国
  - 複数の島を持つ国がある場合でも、海上国境線で囲まれていない限り別領域として扱う（簡略化）。

### 6.4 ポリゴン生成条件
- ポリゴン間に隙間はない。
- 境界および境界点は「共有」されている必要がある。
- 同一陸塊が複数ポリゴンに分割されている可能性があるが隙間はない想定。

### 6.5 点・次数の扱い
- 国境線を構成するすべての点を一度 DB などに記録し、結合関係からポリゴン化する。
- 1 つの点が複数ポリゴンに属する可能性がある。
- 次数の概念を利用する:
  - 他の点と繋がっていない点 → 次数 0
  - 他の 2 点と繋がっている点 → 次数 1
  - これにより国境線の分類が容易になる。

### 6.6 表示レイヤーの一括切替
- 分高面（`_第一分高面`〜`_第五分高面`）は一括で表示/非表示できる。
- 定義済みレイヤー以外のレイヤーは一括で表示/非表示できる。
  - 定義済みレイヤーを内包するグループは対象外とする。
- 一括切替は表示の ON/OFF のみを行い、ポリゴン生成の対象は変えない。

### 6.7 表示操作
- マウスホイールで地図表示を拡大・縮小できる。
  - カーソル位置を中心に拡大縮小し、表示のみを変更する。
- 高倍率まで拡大できる。
- 抽出したポリゴンはクリックで強調表示できる。
  - クリックで単一選択、Shift+クリックで複数選択。
  - 選択領域の外側を暗くして強調する。
  - 複数選択時は選択同士の境界線を表示しない。
  - 再クリックで解除し、別ポリゴンで切り替える。
- 抽出ポリゴンのオーバーレイ透明度を調整できる。

### 6.8 デバッグ表示
- 国タイプの判定結果を色分けで表示できる。
- 色分けの凡例を表示できる。

## 7. データ保存形式（例）
- points: 点の配列（`{x, y}`）
- edges: 線の配列（点インデックスと属性）
- polygons: 点インデックス列で構成されるポリゴン
- 形式は任意だが、境界点共有を前提とする。

## 8. 非機能要件
- HTML + JS の複数ファイル構成だが、オフラインで動作する。
- 大規模 SVG（幅約 20,000px、2.7MB）を扱えること。
- Illustrator 出力の数値表記や癖に耐えること。

## 9. 想定ワークフロー
1) SVG を読み込む  
2) 対象レイヤーを抽出  
3) 国境線と海岸線を統合  
4) 点・線の接続関係を構築  
5) ポリゴン化と国タイプ判定  
6) 保存形式へ出力
