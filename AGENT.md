## 会話方針
- ユーザーとの会話は日本語で行う。

## 作業方針
- 不具合修正は`現状.md`から選んで対応する。
- 修正後は`現状.md`から該当項目を削除する。
    - 削除時、最大番号のものを修正したとき以外は番号がずれないように欠番として残す。
- 不具合対応後、AGENT.mdの知見も更新する。
- 場当たり的な対応を避け、根本原因に対処する。
- 不具合の分析は根拠を引用して提示し、実装に入る前にユーザーから認可を受ける。
- 仕様が変化したときは仕様書を書き換える。

## 知見の蓄積
- 不具合の根本原因は教訓としてAGENT.mdに追記する。
- 調査で苦戦した内容と解決方法もAGENT.mdに追記する。

### 文字コードの扱い
- `現状.md`の内容はUTF-8。`Get-Content`の既定エンコーディングだと文字化けしたため、`Get-Content -Encoding utf8`か`[IO.File]::ReadAllBytes()`で読み込み、UTF-8でデコードして内容を確認した。

### グラフ構築時のフリーズ
- 原因: グラフ構築が大きい同期ループに集中しており、UIスレッドを長時間ブロックしていた。
- 対応: 処理をチャンク化して`requestAnimationFrame`で合間に描画機会を作り、進捗を表示してフリーズ感を解消した。

### 海岸線抽出の冗長
- 原因: 海岸線抽出で分高面レイヤーを全段走査しており、内陸の線分まで取り込んで処理が重くなっていた。
- 対応: 海岸線は最も低い陸地レイヤー（_第一分高面）からのみ抽出し、見つからない場合は除外する。
- 調査で苦戦: なし。現状.mdの指摘どおり第一分高面で海岸線が得られる前提で対応した。

### 複数サブパスの誤結線
- 原因: SVGの`path`が複数サブパス（複数の`M`）を含むのに、`getPointAtLength`で1本としてサンプリングし、サブパス間を直線で結んでしまいグラフが破綻した。
- 対応: `d`を`M`で分割し、サブパスごとにサンプリングして線分化するように修正した。
- 調査で苦戦: 国境界レイヤーでは再現せず、陸地レイヤー内の`path`に複数サブパスが混在していることをSVG解析で特定した。

### 連結成分ごとの外側面除外漏れ
- 原因: 多角形抽出で全体の最大面積だけを外側面として除外していたため、連結成分が複数ある場合に外側面が残っていた。
- 対応: 点・辺の連結成分を算出し、成分ごとに最大面積の面を外側として除外した。
- 調査で苦戦: なし。島国など複数成分のSVGでのみ再現することを確認した。

### 端点近接の未分割
- 原因: 交差判定のみで線分を分割していたため、端点が他線分の途中に近接するケースで分割点が作られず、吸着後に頂点が辺の途中に乗って面抽出が破綻した。
- 対応: `splitSegmentsAtIntersections`で端点→線分の最近距離が吸着許容値以内なら線分側に分割点を追加するように修正した。
- 調査で苦戦: なし。
