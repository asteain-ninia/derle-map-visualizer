## 会話方針
- ユーザーとの会話は日本語で行う。

## 作業方針
- 不具合修正は`現状.md`から選んで対応する。
- 修正後は`現状.md`から該当項目を削除する。
    - 削除時、最大番号のものを修正したとき以外は番号がずれないように欠番として残す。
- 不具合対応後、AGENT.mdの知見も更新する。
- 場当たり的な対応を避け、根本原因に対処する。
- 不具合の分析は根拠を引用して提示し、実装に入る前にユーザーから認可を受ける。
- 仕様が変化したときは仕様書を書き換える。

## 知見の蓄積
- 不具合の根本原因は教訓としてAGENT.mdに追記する。
- 調査で苦戦した内容と解決方法もAGENT.mdに追記する。

### 文字コードの扱い
- `現状.md`の内容はUTF-8。`Get-Content`の既定エンコーディングだと文字化けしたため、`Get-Content -Encoding utf8`か`[IO.File]::ReadAllBytes()`で読み込み、UTF-8でデコードして内容を確認した。

### グラフ構築時のフリーズ
- 原因: グラフ構築が大きい同期ループに集中しており、UIスレッドを長時間ブロックしていた。
- 対応: 処理をチャンク化して`requestAnimationFrame`で合間に描画機会を作り、進捗を表示してフリーズ感を解消した。

### 海岸線抽出の冗長
- 原因: 海岸線抽出で分高面レイヤーを全段走査しており、内陸の線分まで取り込んで処理が重くなっていた。
- 対応: 海岸線は最も低い陸地レイヤー（_第一分高面）からのみ抽出し、見つからない場合は除外する。
- 調査で苦戦: なし。現状.mdの指摘どおり第一分高面で海岸線が得られる前提で対応した。

### 複数サブパスの誤結線
- 原因: SVGの`path`が複数サブパス（複数の`M`）を含むのに、`getPointAtLength`で1本としてサンプリングし、サブパス間を直線で結んでしまいグラフが破綻した。
- 対応: `d`を`M`で分割し、サブパスごとにサンプリングして線分化するように修正した。
- 調査で苦戦: 国境界レイヤーでは再現せず、陸地レイヤー内の`path`に複数サブパスが混在していることをSVG解析で特定した。

### 連結成分ごとの外側面除外漏れ
- 原因: 多角形抽出で全体の最大面積だけを外側面として除外していたため、連結成分が複数ある場合に外側面が残っていた。
- 対応: 点・辺の連結成分を算出し、成分ごとに最大面積の面を外側として除外した。
- 調査で苦戦: なし。島国など複数成分のSVGでのみ再現することを確認した。

### 端点近接の未分割
- 原因: 交差判定のみで線分を分割していたため、端点が他線分の途中に近接するケースで分割点が作られず、吸着後に頂点が辺の途中に乗って面抽出が破綻した。
- 対応: `splitSegmentsAtIntersections`で端点→線分の最近距離が吸着許容値以内なら線分側に分割点を追加するように修正した。
- 調査で苦戦: なし。

### 海まで国境線を引く国の分断
- 原因: 海岸線を無条件で境界線に統合していたため、国境線のみで閉じる国の内部で海岸線が境界扱いとなりポリゴンが分断された。
- 対応: 国境線のみでポリゴン検出した後、次数1の国境線が内包される領域のみ海岸線を保持し、それ以外の内側海岸線を除外する二段階判定に変更した。
- 調査で苦戦: 共有海の判定条件と整合させるため、国境線の次数と内包判定を併用した。

### ポリゴン強調の暗転方向
- 原因: 選択ポリゴンと同じパスに暗色を重ねていたため、選択領域自体が暗転した。
- 対応: viewBox全体の矩形に選択ポリゴンを穴として追加し、`fill-rule: evenodd`で外側のみ暗転するようにした。

### 複数選択時の境界線消失
- 原因: 選択ポリゴンの`stroke`を全消しすると、外周境界まで消えてしまった。
- 対応: 選択ポリゴンは`stroke`を消しつつ、外周のみ別レイヤーで描画して隣接選択間の境界だけ非表示にした。

### 内陸国の誤分類
- 原因: 国タイプ判定が`hasBorder`/`hasCoast`のみで、外周に接しているかを見ていなかったため、内陸国も「海まで国境線」に分類していた。
- 対応: 外側面のエッジ集合を作成し、外周に接している国境のみ「海まで国境線」、それ以外は「内陸国」として分類するよう修正した。
- 調査で苦戦: なし。

### 内海・完全島国の誤分類
- 原因: 外周エッジ接触だけで海岸線接触を判定していたため、内海に面する国や海まで国境の国に囲まれた国が内陸国扱いになっていた。
- 対応: 国境線と海岸線の交差点を抽出し、交差の有無で「海まで国境線」を判定し、交差がなければ領内の海岸線有無で「内陸国/完全島国」を判定するように修正した。
- 調査で苦戦: なし。

### 不要オプションの固定
- 原因: 「海岸線を含める」「交差で分割」のチェックで処理をOFFにできる実装が残っていた。
- 対応: UIと関連参照を削除し、海岸線抽出と交差分割を常時実行するように固定した。
- 調査で苦戦: なし。
